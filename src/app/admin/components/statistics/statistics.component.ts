import { Component, OnInit } from '@angular/core';
import { LocalStorageService } from '../../../core/services/local-storage.service';
import { CommentService } from '../../../core/services/comment.service';
import { IProduct } from '../../../core/interfaces/iproduct';
import { ThemeService } from 'src/app/core/services/theme.service';
import { RetingService } from 'src/app/core/services/reting.service';
import { filter, map, Observable, tap } from 'rxjs';

@Component({
	selector: 'app-statistics',
	templateUrl: './statistics.component.html',
	styleUrls: ['./statistics.component.css'],
})
export class StatisticsComponent implements OnInit {
	totalBooks!: number;
	totalComments!: number;
	popularBooks!: Partial<IProduct>[];
	averageRating = 0;

	constructor(
		private localStorageService: LocalStorageService,
		private commentService: CommentService,
		public themeServise: ThemeService,
		private retingService: RetingService,
	) {}

	ngOnInit(): void {
		this.commentService.listComments$
			.pipe(
				filter(Boolean),
				tap((data) => {
					const sortedIds = data.sort((a, b) => b.comments.length - a.comments.length).map((book) => book.id);
					this.popularBooks = this.getPopularBooks(sortedIds).slice(0, 3);
				}),
				map((data) => {
					this.totalComments = data.reduce((acc, item) => {
						return (acc += item.comments.length);
					}, 0);
				}),
			)
			.subscribe();

		this.localStorageService.listProducts$.pipe(map((data) => data.length)).subscribe((data) => {
			return (this.totalBooks = data);
		});

		this.retingService.getAverageRating().subscribe((data) => {
			this.averageRating = Number(data.toFixed(1));
		});
	}
	getPopularBooks(bookIds: string[]): Partial<IProduct>[] {
		return this.localStorageService.popularBooks(bookIds);
	}
}
